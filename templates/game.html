<!doctype html>
<html>
<head>

<style>
<!--
body {
   background: steelblue;
}

.excharea {
   border-radius: 5px;
   border: 2px white dashed;
   width: 252px;
   height: 126px;
   padding-top: 10px;
   text-align: center;
   color: white;
   font: 2em "Open Sans", sans-serif;
}

.tilescore {
   position: relative;
   transform: translate(-5%, -105%);

   font: 14px "Open Sans", sans-serif;
   text-align: right;
   z-index: 1;
}

.tile {
   position: absolute;
   background: #e6b988;
   border-radius: 3px;
   z-index: 10;
   -moz-box-shadow:    1px 1px 1px 1px #666;
   -webkit-box-shadow: 1px 1px 1px 1px #666;
   box-shadow: 1px 1px 1px 1px #666;
}

.tiletext {
   font: 3em "Open Sans", sans-serif;
   text-align: center;
}

.board {
   background: black;
}

.tw {
   font: 12px "Open Sans", sans-serif;
   text-align: center;
   background: orange;
}

.dw {
   font: 12px "Open Sans", sans-serif;
   text-align: center;
   background: red;
}

.tl {
   font: 12px "Open Sans", sans-serif;
   text-align: center;
   background: #06a006;
   vertical-align: middle;
}

.dl {
   font: 12px "Open Sans", sans-serif;
   text-align: center;
   background: lightblue;
}

.home {
   background: red;
}

.bl {
   background: white;
}

.tileblank {
   background: #e0ffe0;
   position: relative;
}

.button {
   height: 65px;
   font: 2em "Open Sans", sans-serif;
}

.player {
   font: 2em "Open Sans", sans-serif;
   padding: 4px 4px 4px 4px;
   border-radius: 5px;
}

.playerturn {
   font: 2em "Open Sans", sans-serif;
   border-radius: 5px;
   padding: 4px 4px 4px 4px;
   background: rgba(255, 255, 255, 0.5);
}

.noselect {
	-webkit-touch-callout: none;
	-webkit-user-select: none;
	-khtml-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;
}

-->
</style>

<script type="text/javascript" src="/js/globals.js"></script>
<script type="text/javascript" src="/js/ui.js"></script>
<script type="text/javascript" src="/js/game.js"></script>

</head>
<body>

<table border=0 width=100%>
<tr><td align=center>
   <!-- board -->
   <table id="board" border=0 width="991px" height="991px"></table>

   <br>
   <br>

   <table border=0>
   <tr id="bottompanel">
      <td>
         <div id="exchangeArea" class="excharea">
            Exchange<br/>
            Tiles
         </div>
      </td>
      <td>
         <!-- tile rack -->
         <table id="tilerack" border=0 align=center></table>
         <!-- buttons -->
         <table align=center>
         <tr>
            <td>
               <input type=button id="shufbutton" class="button" value="SHUF" disabled=True onclick="click_shuf_tiles();">
            </td>
            <td>
               <input type=button id="exchbutton" class="button" value="EXCH" disabled=True>
            </td>
            <td>
               <input type=button id="passbutton" class="button" value="PASS" disabled=True onclick="click_pass_button();">
            </td>
            <td>
               <input type=button id="playbutton" class="button" value="PLAY" disabled=True onclick="click_play_button();">
            </td>
         </tr>
         </table>
      </td>
   </tr>
   </table>

</td></tr>
</table>

<table id=connectpanel>
   <tr>
      <td><input type=button value="Connect as viewer" onclick="connect_as_viewer();"></td>
      <td>
         <input id=name size=8>
         <input id=password size=8>
         <input type=button value="Join" onclick="connect_as_player();">
      </td>
   </tr>
</table>

<script>
<!--
setupBoard();
setupRack();
buttonsDisabled(true);
-->
</script>

<script>
// WEB-SOCKET

var ClientState = Object.freeze({
   "start": 0,
   "wait_viewer_ack": 1,
   "viewer": 2,
   "wait_join_ack": 3,
   "wait_game_start": 4,
   "turn": 5,
   "wait_turn_ack":6,
   "wait_turn": 7,
   "game_over": 8});
   
var state = ClientState.start;

var sock = new WebSocket("ws://sharadb.net:5052/");
//var sock = new WebSocket("ws://192.168.1.221:5052/");
sock.onopen = function (event) {
   console.log("connected to server");
   console.log(event);
}
sock.onerror = function (event) {
   console.log("error");
   console.log(event);
}
sock.onmessage = function (event) {
   var msg = JSON.parse(event.data);
   console.log("Client state=" + state + " msg=" + msg);

   if (state == ClientState.start) {
      // ignore all messages
      return;

   } else if (state == ClientState.wait_viewer_ack) {
      // viewer mode
      if (msg[0] == "VIEW-OKAY") {
         state = ClientState.viewer;
         return;
      } else if (msg[0] == "VIEW-BAD") {
         alert(msg[1]);
         state = ClientState.start;
         show_connect_panel();
         return;
      } else {
         // ignore all other messages
      }
      return;

   } else if (state == ClientState.wait_join_ack) {
      // connecting as player
      if (msg[0] == "JOIN-OKAY") {
         state = ClientState.wait_game_start;
         return;
      } else if (msg[0] == "JOIN-BAD") {
         state = ClientState.start;
         show_connect_panel();
         return;
      } else {
         // ignore all other messages
      }
      return;

   } else if (state == ClientState.wait_game_start) {
      if (msg[0] == "RACKTILES") {
         processRackTilesMessage(msg);
         return;
      }

   } else if (state == ClientState.wait_turn_ack) {
      // just made a move and waitnig for confirmation

      if (msg[0] == "PLAY-BAD" || msg[0] == "PASS-BAD") {
         state = ClientState.turn;
         click_shuf_tiles();
         return;
      } else if (msg[0] == "PLAY-OKAY") {
         state = ClientState.wait_turn;
         processPlayOkayMessage(msg);
         return;
      } else if (msg[0] == "PASS-OKAY") {
         state = ClientState.wait_turn;
         return;
      }

   }

   // Commands that work in several state
   if (msg[0] == "GAME-OVER") {
      processGameOverMessage(msg);

   } else if (msg[0] == "SCORE") {
      processScoreMessage(msg);

      for (var i=0; i<playerScoreList.length; i++) {
         showPlayerScore(i, playerScoreList[i][1]);
      }

   } else if (msg[0] == "TURN") {
      processTurnMessage(msg);

   } else if (msg[0] == "BOARDTILES") {
      processBoardTilesMessage(msg);

   } else if (msg[0] == "RACKTILES") {
      processRackTilesMessage(msg);

   } else if (msg[0] == "PLAY-OKAY") {
      state = ClientState.wait_turn;
      processPlayOkayMessage(msg);

   } else if (msg[0] == "PASS-OKAY") {
      state = ClientState.wait_turn;
      return;

   }

}
-->
</script>

<div id="status"></div>

</body>
</html>
